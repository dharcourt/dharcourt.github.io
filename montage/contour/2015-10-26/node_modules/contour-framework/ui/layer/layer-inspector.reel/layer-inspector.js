var Component = require("montage/ui/component").Component,
    Layer = require("logic/model/layer").Layer,
    FeatureInspector = require("ui/feature/feature-inspector.reel").FeatureInspector;

/**
 * @class LayerInspector
 * @extends external:Component
 */
exports.LayerInspector = Component.specialize(/** @lends LayerInspector.prototype */{

    identifier: {
        value: "layerInspector"
    },

    layerReference: { // Set by owner.
        get: function () {
            return this._layerReference;
        },
        set: function (reference) {
            if (reference !== this._layerReference) {
                this.dispatchBeforeOwnPropertyChange("_currentTabs", this._currentTabs);
                this._layerReference = reference || undefined;
                this.dispatchOwnPropertyChange("_currentTabs", this._currentTabs);
                if (this._tabBar) {
                    this._tabBar.selectedIndex = 0;
                }
            }
        }
    },

    _succession: { // Set in serialization.
        value: undefined
    },

    _tabBar: { // Set in serialization.
        value: undefined
    },

    _allTabs: { // Set in serialization.
        value: undefined
    },

    _currentTabs: { // Used in serialization.
        get: function () {
            var tabs, i, n;
            if (this.layerReference) {
                for (i = 0, n = this.layerReference.layers.length; i < n && !tabs; i += 1) {
                    if (this.layerReference.layers[i].type === Layer.Type.FEATURE) {
                        tabs = this._allTabs;
                    }
                }
            }
            return tabs || this._featurelessTabs;
        }
    },

    _featurelessTabs: {
        get: function () {
            if (!this.__featurelessTabs && this._allTabs) {
                this.__featurelessTabs = [this._allTabs[0]];
            }
            return this.__featurelessTabs;
        }
    },

    _infoPane: { // Set in serialization.
        get: function () {
            return this.__infoPane;
        },
        set: function (pane) {
            this.__infoPane = pane;
            this.defineBinding("__infoPane.layerReference", {"<-": "layerReference"});
        }
    },

    // Returns a promise.
    _featuresPane: {
        get: function () {
            var self = this;
            return require.async("ui/feature/feature-list.reel").then(function (exports) {
                self.__featuresPane = new exports.FeatureList();
                self.__featuresPane.succession = self._succession;
                self.__featuresPane.owner = self;
                self.__featuresPane.defineBinding("layer", {"<-": "owner.layerReference.layers.0"});
                self.__featuresPane.defineBinding("features", {"<-": "owner.layerReference.layers.0.features.visible"});
                return self.__featuresPane;
            });
        }
    }

});